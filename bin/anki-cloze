#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift File.expand_path("../lib", __dir__)

require "anki_cloze/sentence"
require "anki_cloze/chunk"
require "anki_cloze/arrangement"
require "anki_cloze/cloze_set"
require "anki_cloze/formatter"
require "anki_cloze/generator"

# T023-T024: CLI implementation for multi-word cloze generation
HELP_TEXT = <<~HELP
  Usage: anki-cloze [SENTENCE]

  Generate multi-word Anki cloze deletion flashcards from a sentence.
  Creates all possible N-word cloze deletions for N from 1 to ceil(word_count/2).

  Arguments:
    SENTENCE    Sentence to convert. If omitted, reads from stdin.

  Options:
    --help      Show this help message

  Examples:
    anki-cloze "The quick brown fox"
    echo "Hello world" | anki-cloze
    anki-cloze < input.txt

  Output:
    {{c1::The}} quick brown fox
    The {{c1::quick}} brown fox
    The quick {{c1::brown}} fox
    The quick brown {{c1::fox}}
    {{c1::The quick}} {{c1::brown fox}}
HELP

begin
  # Handle --help flag
  if ARGV.include?("--help") || ARGV.include?("-h")
    puts HELP_TEXT
    exit 0
  end

  # T023: ARGV input takes precedence, fall back to stdin
  input = if ARGV.any?
    ARGV.join(" ")
  elsif !$stdin.tty?
    $stdin.read.strip
  else
    ""
  end

  # T024: Error handling for empty input
  if input.empty?
    $stderr.puts "Error: Input sentence cannot be empty"
    exit 1
  end

  # Generate and output cloze deletions
  generator = AnkiCloze::Generator.new(input)
  results = generator.generate

  results.each do |line|
    puts line
  end

  exit 0
rescue ArgumentError => e
  # T024: Handle validation errors
  $stderr.puts "Error: #{e.message}"
  exit 1
rescue StandardError => e
  # T024: Handle unexpected errors
  $stderr.puts "Error: #{e.message}"
  exit 2
end
