#!/usr/bin/env ruby
# frozen_string_literal: true

$LOAD_PATH.unshift File.expand_path("../lib", __dir__)

require "anki_cloze/sentence"
require "anki_cloze/chunk"
require "anki_cloze/arrangement"
require "anki_cloze/cloze_set"
require "anki_cloze/formatter"
require "anki_cloze/generator"
require "optparse"

# T023-T024: CLI implementation for multi-word cloze generation
HELP_TEXT = <<~HELP
  Usage: anki-cloze [OPTIONS] [SENTENCE]

  Generate multi-word Anki cloze deletion flashcards from a sentence.
  Creates all possible N-word cloze deletions for N from 1 to ceil(word_count/2).

  Arguments:
    SENTENCE    Sentence to convert. If omitted, reads from stdin.

  Examples:
    anki-cloze "The quick brown fox"
    anki-cloze --minimum 3 "The quick brown fox"
    anki-cloze --maximum 1 "The quick brown fox"
    anki-cloze -m 2 -x 3 "The quick brown fox"
    echo "Hello world" | anki-cloze -m 2
    anki-cloze < input.txt

  Output:
    {{c1::The}} quick brown fox
    The {{c1::quick}} brown fox
    The quick {{c1::brown}} fox
    The quick brown {{c1::fox}}
    {{c1::The quick}} {{c1::brown fox}}

  Options:
HELP

begin
  # Parse options
  min_chunk_size = 1
  max_chunk_size = nil
  
  parser = OptionParser.new do |opts|
    opts.banner = HELP_TEXT
    
    opts.on("-m", "--minimum X", Integer, "Minimum chunk size to emit (must be >= 1)") do |m|
      if m < 1
        $stderr.puts "Error: --minimum value must be at least 1"
        exit 1
      end
      min_chunk_size = m
    end
    
    opts.on("-x", "--maximum X", Integer, "Maximum chunk size to emit (must be >= 1)") do |x|
      if x < 1
        $stderr.puts "Error: --maximum value must be at least 1"
        exit 1
      end
      max_chunk_size = x
    end
    
    opts.on("-h", "--help", "Show this help message") do
      puts opts
      exit 0
    end
  end
  
  parser.parse!

  # T023: ARGV input takes precedence, fall back to stdin
  input = if ARGV.any?
    ARGV.join(" ")
  elsif !$stdin.tty?
    $stdin.read.strip
  else
    ""
  end

  # T024: Error handling for empty input
  if input.empty?
    $stderr.puts "Error: Input sentence cannot be empty"
    exit 1
  end

  # Generate and output cloze deletions
  generator = AnkiCloze::Generator.new(input, min_chunk_size: min_chunk_size, max_chunk_size: max_chunk_size)
  results = generator.generate

  results.each do |line|
    puts line
  end

  exit 0
rescue OptionParser::InvalidArgument, OptionParser::InvalidOption => e
  # Handle option parsing errors
  $stderr.puts "Error: #{e.message}"
  exit 1
rescue ArgumentError => e
  # T024: Handle validation errors
  $stderr.puts "Error: #{e.message}"
  exit 1
rescue StandardError => e
  # T024: Handle unexpected errors
  $stderr.puts "Error: #{e.message}"
  exit 2
end
